<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koziar Plany PRO v4.1</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#0a0a0a">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #0a0a0a; --card: #161616; --border: #2a2a2a; --text: #ffffff;
            --gold: #d4af37; --gold-glow: rgba(212, 175, 55, 0.4);
            --danger: #ff4444; --pro: #3b82f6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg); color: var(--text); padding-bottom: 120px;
        }

        /* HEADER */
        header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px);
            padding: 10px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }

        #planSelect { 
            background: var(--card); color: var(--gold); border: 1px solid var(--border);
            padding: 10px; border-radius: 8px; flex: 1; font-weight: 700; font-size: 14px; outline: none;
        }

        .header-actions { display: flex; gap: 6px; }

        .icon-btn {
            background: var(--card); color: var(--text); border: 1px solid var(--border);
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .icon-btn.gold { background: var(--gold); color: #000; border: none; }
        .icon-btn.active-pro { border-color: var(--pro); color: var(--pro); box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }

        /* MAIN */
        main { padding: 12px; max-width: 1000px; margin: 0 auto; }

        .day { 
            background: var(--card); margin-bottom: 25px; border-radius: 16px; 
            border: 1px solid var(--border); overflow: hidden;
        }
        .day.inactive { opacity: 0.3; filter: grayscale(1); }
        .day.active-today { border-color: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }

        .day-header {
            background: rgba(255,255,255,0.03); padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .day-title {
            background: transparent; border: none; color: var(--gold);
            font-size: 15px; font-weight: 900; text-transform: uppercase; outline: none;
        }

        /* TABELA */
        .table-scroll { width: 100%; overflow-x: auto; position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        
        th { font-size: 10px; color: #555; padding: 12px 5px; text-transform: uppercase; text-align: center; border-bottom: 1px solid var(--border); }
        td { border-bottom: 1px solid var(--border); padding: 0; }

        /* Sticky Columns */
        .sticky-col { position: sticky; left: 0; background: var(--card); z-index: 10; border-right: 1px solid var(--border); }
        tr.done .sticky-col { background: #1a1812; }

        input[type="text"] { 
            width: 100%; background: transparent; border: none; 
            color: var(--text); padding: 14px 2px; font-size: 14px; text-align: center; outline: none;
        }

        .col-check { width: 45px; }
        .col-nr { width: 40px; }
        .col-name { width: 170px; text-align: left !important; }
        .col-data { width: 50px; }
        .col-hide { display: none !important; }

        .name-box { display: flex; align-items: center; gap: 8px; padding-left: 10px; }
        .name-box input { text-align: left; font-weight: 600; }

        .info-btn { color: #333; cursor: pointer; transition: 0.2s; }
        .info-btn.has-data { color: var(--gold); }

        /* DETAILS */
        .details-row { display: none; background: #000; }
        .details-row.open { display: table-row; }
        .details-content { padding: 15px; }
        .details-content textarea { 
            width: 100%; background: #111; border: 1px solid #333; 
            color: #888; padding: 12px; border-radius: 8px; font-size: 13px; resize: none;
        }

        /* ACTIONS */
        tr.done { background: rgba(212, 175, 55, 0.05); }
        tr.done input { color: #555 !important; text-decoration: line-through; }
        input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--gold); }

        .btn-add-row { 
            width: 100%; padding: 18px; background: transparent; 
            color: var(--gold); border: none; border-top: 1px solid var(--border); 
            font-weight: 900; font-size: 12px; cursor: pointer; text-transform: uppercase;
        }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-box { background: var(--card); width: 100%; max-width: 450px; padding: 25px; border-radius: 15px; border: 1px solid var(--border); }
        
        .floating-logo { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: #000; border: 2px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1000; box-shadow: 0 0 15px var(--gold-glow); }
    </style>
</head>
<body id="bodyTag">

<header>
    <select id="planSelect" onchange="loadPlan()"></select>
    <div class="header-actions">
        <button id="resetBtn" class="icon-btn" style="color:var(--danger)" title="Resetuj tydzień" onclick="resetWeek()"><i data-lucide="rotate-ccw"></i></button>
        <button id="proBtn" class="icon-btn" title="Tryb PRO" onclick="toggleProMode()"><i data-lucide="zap"></i></button>
        <button class="icon-btn gold" title="Nowy Plan" onclick="newPlan()"><i data-lucide="plus"></i></button>
        <button class="icon-btn" onclick="openImport()"><i data-lucide="download"></i></button>
        <button class="icon-btn" onclick="exportPlan()"><i data-lucide="share-2"></i></button>
    </div>
</header>

<main>
    <div id="app"></div>
</main>

<div class="modal" id="importModal">
    <div class="modal-box">
        <h3 style="color:var(--gold); margin-top:0">Importuj Plan TSV</h3>
        <textarea id="importText" style="width:100%; height:200px; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:8px; font-size:10px" placeholder="Wklej kod planu..."></textarea>
        <button class="icon-btn" style="width:100%; margin-top:15px; background:var(--gold); color:#000; font-weight:900" onclick="applyImport()">IMPORTUJ</button>
        <button class="icon-btn" style="width:100%; margin-top:8px; border:none" onclick="closeModals()">Anuluj</button>
    </div>
</div>

<div class="floating-logo" onclick="window.scrollTo({top:0, behavior:'smooth'})">
    <img src="logo.png" alt="K" style="width:85%; border-radius:50%" onerror="this.style.display='none'">
</div>

<script>
let plans = JSON.parse(localStorage.getItem("koziar_plans_v4")) || {};
let checks = JSON.parse(localStorage.getItem("koziar_checks_v4")) || {};
let currentPlan = localStorage.getItem("koziar_current") || "";
let editStates = {};
let openDetails = {};

function parseTSV(text) {
    const lines = text.trim().split("\n");
    let days = [], day = null, notes = "", pro = false;
    
    lines.forEach(line => {
        if (line.startsWith("!!PRO!!")) pro = true;
        else if (line.startsWith("!!NOTES!!")) notes = line.split("\t")[1]?.replace(/\[BR\]/g, "\n") || "";
        else if (line.startsWith("#")) {
            const [name, status] = line.replace("#", "").split("|").map(s => s.trim());
            day = { name, active: status === "AKTYWNY", rows: [] };
            days.push(day);
        } else if (day && line.trim()) {
            const parts = line.split("\t").map(p => p.trim());
            if (parts[0] === "Nr" || parts[0] === "Nazwa") return;
            
            let row = new Array(10).fill("");
            // Naprawa starych planów (4 kolumny)
            if (parts.length <= 4 && !text.includes("Nazwa\tS")) {
                row[1] = parts[0] || ""; row[2] = parts[1] || ""; row[3] = parts[2] || ""; row[4] = parts[3] || "";
            } else {
                parts.forEach((val, idx) => { if(idx < 10) row[idx] = val; });
            }
            day.rows.push(row);
        }
    });
    return { days, notes, proMode: pro };
}

function render() {
    const container = document.getElementById("app");
    const p = plans[currentPlan];
    if (!p) { container.innerHTML = "<p style='text-align:center; padding:50px; color:#555'>Wklej lub dodaj swój pierwszy plan.</p>"; return; }

    document.getElementById("proBtn").classList.toggle("active-pro", p.proMode);
    
    container.innerHTML = p.days.map((day, di) => {
        const isEditing = editStates[di];
        return `
            <div class="day ${day.active ? '' : 'inactive'} ${hasChecks(di) ? 'active-today' : ''}">
                <div class="day-header">
                    <input class="day-title" value="${day.name}" ${isEditing ? '' : 'readonly'} oninput="updateDayName(${di}, this.value)">
                    <div style="display:flex; gap:6px">
                        <button class="icon-btn" style="width:32px; height:32px" onclick="toggleDayActive(${di})"><i data-lucide="${day.active ? 'eye' : 'eye-off'}" style="width:14px"></i></button>
                        <button class="icon-btn ${isEditing ? 'gold' : ''}" style="width:70px; height:32px; font-size:10px; font-weight:900" onclick="toggleEdit(${di})">${isEditing ? 'GOTOWE' : 'EDYTUJ'}</button>
                    </div>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sticky-col col-check">✔</th>
                                <th class="col-nr ${!p.proMode && !isEditing ? 'col-hide' : ''}">Nr</th>
                                <th class="sticky-col col-name" style="left:45px">Ćwiczenie</th>
                                <th class="col-data">S</th><th class="col-data">P</th><th class="col-data">KG</th>
                                <th class="col-data ${!p.proMode && !isEditing ? 'col-hide' : ''}">Rest</th>
                                <th class="col-data ${!p.proMode && !isEditing ? 'col-hide' : ''}">RIR</th>
                                <th class="col-data ${!p.proMode && !isEditing ? 'col-hide' : ''}">Tempo</th>
                                <th class="col-data ${!p.proMode && !isEditing ? 'col-hide' : ''}">Prog</th>
                                ${isEditing ? '<th style="width:40px">✕</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${day.rows.map((row, ri) => renderRow(di, ri, row, p.proMode, isEditing)).join('')}
                        </tbody>
                    </table>
                </div>
                ${isEditing ? `<button class="btn-add-row" onclick="addRow(${di})">+ Dodaj ćwiczenie</button>` : ''}
            </div>
        `;
    }).join('');
    lucide.createIcons();
}

function renderRow(di, ri, row, isPro, isEditing) {
    const isDone = checks[currentPlan]?.[di]?.[ri];
    const isOpen = openDetails[`${di}-${ri}`];
    const hide = (idx) => !isEditing && (!isPro || !row[idx]);

    return `
        <tr class="${isDone ? 'done' : ''}">
            <td class="sticky-col col-check" style="text-align:center">
                <input type="checkbox" ${isDone ? 'checked' : ''} onchange="setCheck(${di},${ri},this.checked)">
            </td>
            <td class="col-nr ${hide(0) ? 'col-hide' : ''}">
                <input type="text" value="${row[0]||''}" oninput="upd(${di},${ri},0,this.value)">
            </td>
            <td class="sticky-col col-name" style="left:45px">
                <div class="name-box">
                    <i data-lucide="info" class="info-btn ${row[9]?'has-data':''}" onclick="toggleDetails(${di},${ri})"></i>
                    <input type="text" value="${row[1]||''}" oninput="upd(${di},${ri},1,this.value)">
                </div>
            </td>
            <td class="col-data"><input type="text" value="${row[2]||''}" oninput="upd(${di},${ri},2,this.value)"></td>
            <td class="col-data"><input type="text" value="${row[3]||''}" oninput="upd(${di},${ri},3,this.value)"></td>
            <td class="col-data"><input type="text" value="${row[4]||''}" oninput="upd(${di},${ri},4,this.value)"></td>
            
            <td class="col-data ${hide(5) ? 'col-hide' : ''}"><input type="text" value="${row[5]||''}" oninput="upd(${di},${ri},5,this.value)"></td>
            <td class="col-data ${hide(6) ? 'col-hide' : ''}"><input type="text" value="${row[6]||''}" oninput="upd(${di},${ri},6,this.value)"></td>
            <td class="col-data ${hide(7) ? 'col-hide' : ''}"><input type="text" value="${row[7]||''}" oninput="upd(${di},${ri},7,this.value)"></td>
            <td class="col-data ${hide(8) ? 'col-hide' : ''}"><input type="text" value="${row[8]||''}" oninput="upd(${di},${ri},8,this.value)"></td>
            
            ${isEditing ? `<td style="text-align:center; color:var(--danger)" onclick="delRow(${di},${ri})"><i data-lucide="trash-2" style="width:14px"></i></td>` : ''}
        </tr>
        <tr class="details-row ${isOpen ? 'open' : ''}">
            <td colspan="12">
                <div class="details-content">
                    <textarea placeholder="Notatki, technika, linki..." oninput="upd(${di},${ri},9,this.value)">${row[9]||''}</textarea>
                </div>
            </td>
        </tr>
    `;
}

// FUNKCJE
function upd(di, ri, ci, v) { plans[currentPlan].days[di].rows[ri][ci] = v; save(); }
function setCheck(di, ri, v) {
    if(!checks[currentPlan]) checks[currentPlan] = {};
    if(!checks[currentPlan][di]) checks[currentPlan][di] = {};
    checks[currentPlan][di][ri] = v; save(); render();
}
function save() {
    localStorage.setItem("koziar_plans_v4", JSON.stringify(plans));
    localStorage.setItem("koziar_checks_v4", JSON.stringify(checks));
    localStorage.setItem("koziar_current", currentPlan);
}
function toggleProMode() { plans[currentPlan].proMode = !plans[currentPlan].proMode; save(); render(); }
function toggleEdit(di) { editStates[di] = !editStates[di]; render(); }
function toggleDetails(di, ri) { const k=`${di}-${ri}`; openDetails[k]=!openDetails[k]; render(); }
function toggleDayActive(di) { plans[currentPlan].days[di].active = !plans[currentPlan].days[di].active; save(); render(); }
function resetWeek() { if(confirm("Zresetować wszystkie odznaczenia w tym planie?")) { checks[currentPlan] = {}; save(); render(); } }
function addRow(di) { plans[currentPlan].days[di].rows.push(new Array(10).fill("")); save(); render(); }
function delRow(di, ri) { plans[currentPlan].days[di].rows.splice(ri,1); save(); render(); }
function updateDayName(di, v) { plans[currentPlan].days[di].name = v; save(); }

function openImport() { document.getElementById("importModal").classList.add("active"); }
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
function applyImport() {
    const text = document.getElementById("importText").value;
    if(!text) return;
    const name = "Import_" + new Date().toLocaleDateString();
    plans[name] = parseTSV(text);
    currentPlan = name; save(); location.reload();
}

function exportPlan() {
    const p = plans[currentPlan];
    let out = p.proMode ? "!!PRO!!\n" : "";
    out += `!!NOTES!!\t${(p.notes||"").replace(/\n/g, "[BR]")}\n`;
    p.days.forEach(d => {
        out += `# ${d.name} | ${d.active ? 'AKTYWNY' : 'PRZERWA'}\n`;
        out += "Nr\tNazwa\tS\tP\tKG\tRest\tRIR\tTempo\tProg\tDesc\n";
        d.rows.forEach(r => out += r.join("\t") + "\n");
    });
    const blob = new Blob([out], {type: "text/tab-separated-values"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = currentPlan+".tsv"; a.click();
}

function initSelect() {
    const s = document.getElementById("planSelect");
    s.innerHTML = Object.keys(plans).map(k => `<option value="${k}" ${k===currentPlan?'selected':''}>${k}</option>`).join('');
}
function loadPlan() { currentPlan = document.getElementById("planSelect").value; render(); }
function hasChecks(di) { return Object.values(checks[currentPlan]?.[di] || {}).some(v => v); }
function newPlan() {
    const n = prompt("Nazwa nowego planu:");
    if(n) {
        plans[n] = { days: [{name: "Dzień 1", active: true, rows: []}], notes: "", proMode: false };
        currentPlan = n; save(); location.reload();
    }
}

// Inicjalizacja
if(Object.keys(plans).length > 0) {
    if(!currentPlan) currentPlan = Object.keys(plans)[0];
    initSelect(); render();
} else { openImport(); }
</script>
</body>
</html>
