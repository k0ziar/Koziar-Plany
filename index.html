<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koziar Plany</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --card: #161616;
            --border: #2a2a2a;
            --text: #ffffff;
            --gold: #d4af37;
            --gold-glow: rgba(212, 175, 55, 0.3);
            --danger: #ff4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; }

        /* POPRAWIONY HEADER MOBILNY */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(15px);
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex; 
            flex-wrap: wrap; /* Pozwala elementom przejść niżej jeśli braknie miejsca */
            align-items: center; 
            gap: 6px;
        }

        #planSelect { 
            background: var(--card); color: var(--gold); 
            border: 1px solid var(--border); padding: 10px; 
            border-radius: 8px; 
            flex: 1; /* Zajmuje całą dostępną przestrzeń */
            min-width: 140px; /* Nie pozwoli się ścisnąć za bardzo */
            max-width: 100%; /* Nie wyjdzie poza ekran */
            font-weight: 600; font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Dodaje "..." gdy nazwa jest za długa */
        }
        
        .header-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0; /* Nie pozwala ikonom się ścisnąć */
        }

        .icon-btn {
            background: var(--card); color: var(--text);
            border: 1px solid var(--border);
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .icon-btn.gold { background: var(--gold); color: #000; border: none; }

        main { padding: 12px; max-width: 600px; margin: 0 auto; }

        .notes-area {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 20px; padding: 10px;
        }
        .notes-area label {
            display: block; color: var(--gold); font-size: 10px;
            font-weight: bold; text-transform: uppercase; margin-bottom: 5px;
        }
        .notes-area textarea {
            width: 100%; background: transparent; border: none;
            color: #bbb; font-size: 13px; font-family: inherit;
            resize: none; outline: none; min-height: 40px;
        }

        .day { 
            background: var(--card); margin-bottom: 15px; 
            border-radius: 16px; border: 1px solid var(--border); 
            overflow: hidden; transition: opacity 0.3s;
        }
        .day.inactive { opacity: 0.25; filter: grayscale(1); }
        .day.active-today { border-color: var(--gold); box-shadow: 0 5px 20px var(--gold-glow); }

        .day-header {
            background: rgba(255,255,255,0.03); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        
        .day-title-input {
            background: transparent; border: 1px dashed transparent;
            color: var(--gold); font-size: 14px; font-weight: 700;
            text-transform: uppercase; padding: 4px; width: 60%;
        }
        .editing .day-title-input { border-color: #444; background: rgba(0,0,0,0.2); }

        table { width: 100%; border-collapse: collapse; }
        th { font-size: 9px; color: #555; padding: 10px 4px; text-transform: uppercase; }
        td { border-top: 1px solid var(--border); padding: 2px; text-align: center; }

        input { width: 100%; background: transparent; border: none; color: var(--text); padding: 12px 2px; font-size: 15px; text-align: center; }
        input:focus { background: rgba(255,255,255,0.05); outline: none; }
        
        .ex-name { text-align: left; padding-left: 10px; width: auto; min-width: 110px; }
        .ex-name input { text-align: left; font-weight: 500; }
        .col-s, .col-p, .col-kg { width: 42px; }
        .col-check { width: 40px; }

        .edit-ui { display: none; width: 80px; }
        .editing .edit-ui { display: table-cell; }
        .editing .btn-add-row { display: block; }
        
        .btn-add-row { 
            display: none; width: 100%; padding: 15px; 
            background: transparent; color: var(--gold); 
            border: 1px dashed var(--gold); border-top: 1px solid var(--border); 
            font-weight: 600; cursor: pointer;
        }

        .row-ops { display: flex; gap: 10px; align-items: center; justify-content: center; }
        .move-up-down { display: flex; flex-direction: column; gap: 4px; }
        .move-up-down button { 
            padding: 4px 8px; font-size: 11px; background: #222; 
            border: 1px solid #444; color: #fff; border-radius: 4px; cursor: pointer; 
        }

        @keyframes highlight {
            0% { background: var(--gold); }
            100% { background: transparent; }
        }
        .moved-row { animation: highlight 1s ease-out; }

        tr.done { background: rgba(212, 175, 55, 0.05); }
        tr.done input { color: #555; text-decoration: line-through; }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--gold); cursor: pointer; }

        .floating-logo {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            background: #000; border: 2px solid var(--gold);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 1000; cursor: pointer;
            overflow: hidden;
        }
        .floating-logo img { width: 100%; height: 100%; object-fit: cover; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1001; padding: 20px; }
        .modal.active { display: flex; }
        .modal-box { background: var(--card); width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; border: 1px solid var(--gold); }
    </style>
</head>
<body>

<header>
    <select id="planSelect" onchange="loadPlan()"></select>
    <div class="header-actions">
        <button class="icon-btn gold" onclick="newPlan()"><i data-lucide="plus"></i></button>
        <button class="icon-btn" onclick="resetWeek()"><i data-lucide="rotate-ccw"></i></button>
        <button class="icon-btn" onclick="openExport()"><i data-lucide="share-2"></i></button>
        <button class="icon-btn" onclick="openImport()"><i data-lucide="download"></i></button>
        <button class="icon-btn" style="color:var(--danger)" onclick="deletePlan()"><i data-lucide="trash-2"></i></button>
    </div>
</header>

<main>
    <div class="notes-area">
        <label>Notatki i Wskazówki</label>
        <textarea id="planNotes" placeholder="Np. Tempo pracy, RPE..." oninput="autoHeight(this); saveNotes()"></textarea>
    </div>
    <div id="week"></div>
</main>

<a href="test.html" class="floating-logo">
    <img src="logo.png" alt="K" onerror="this.style.display='none'">
</div>

<div class="modal" id="exportModal"><div class="modal-box"><h3 style="color:var(--gold);margin-top:0">Eksportuj</h3><textarea id="exportText" style="height:200px;width:100%;background:#000;color:#0d0;font-size:10px;" readonly></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px"><button class="icon-btn gold" style="width:100%" onclick="downloadTSV()">ZAPISZ</button><button class="icon-btn" style="width:100%" onclick="closeModals()">ZAMKNIJ</button></div></div></div>
<div class="modal" id="importModal"><div class="modal-box"><h3 style="color:var(--gold);margin-top:0">Importuj</h3><input type="file" id="importFile" accept=".tsv,.csv" onchange="handleFileSelect(event)" style="margin-bottom:10px;font-size:12px;"><textarea id="importText" style="height:150px;width:100%;background:#000;color:#fff;"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px"><button class="icon-btn gold" style="width:100%" onclick="applyImport()">IMPORTUJ</button><button class="icon-btn" style="width:100%" onclick="closeModals()">ANULUJ</button></div></div></div>

<script>
// --- KONFIGURACJA WERSJI I PLANÓW ---
const GLOBAL_PLAN_VERSION = "1.2"; // Podniesiona wersja, aby wymusić aktualizację u użytkowników
const DEFAULT_PLAN_3D = "3-dniowy FBW - by Koziar";
const DEFAULT_PLAN_4D = "4-dniowy Upper/Lower - by Koziar";
const DEFAULT_PLAN_5D = "5-dniowy U/L/PPL - by Koziar";

function getDefaultPlans() {
    return {
        [DEFAULT_PLAN_3D]: {
            version: GLOBAL_PLAN_VERSION,
            notes: "Przykładowy trening 3 dniowy Full Body Workout dla osób początkujących.\n\nRób ćwiczenia do upadku, notuj ciężary, jeśli robisz więcej powtórzeń tym samym ciężarem co tydzień temu - Dołóż sobie.\n\nSam notuj serie, powtórzenia i ciężar. Baw się, eksperymentuj, progresuj i dowolnie modyfikuj pod samego siebie.",
            days: [
                { name: "Poniedziałek - FBW A", active: true, rows: [["Przysiady","4","6-10",""],["Wyciskanie ławka płaska","4","6-10",""],["Wiosłowanie","4","8-12",""],["OHP","4","8-12",""],["Biceps","3","8-12",""],["Triceps","3","8-12",""],["Brzuch","4","8-12",""]] },
                { name: "Wtorek", active: false, rows: [] },
                { name: "Środa - FBW B", active: true, rows: [["Wyciskanie ławka płaska","4","6-10",""],["Suwnica/Przysiad wąsko","4","8-12",""],["Podciąganie neutralny chwyt","4","8-12",""],["Wznosy","3","8-12",""],["Triceps","3","8-12",""],["Biceps","3","8-12",""],["Łydki","4","15+",""]] },
                { name: "Czwartek", active: false, rows: [] },
                { name: "Piątek - FBW C", active: true, rows: [["Przysiad","4","6-10",""],["Martwy ciąg","4","6-10",""],["Wiosłowanie szeroko","4","8-12",""],["Wyciskanie skos","3","8-12",""],["Dipy","3","8-12",""],["Biceps","4","8-12",""],["Brzuch","4","8-12",""]] },
                { name: "Sobota", active: false, rows: [] },
                { name: "Niedziela", active: false, rows: [] }
            ]
        },
        [DEFAULT_PLAN_4D]: {
            version: GLOBAL_PLAN_VERSION,
            notes: "Przykładowy trening 4 dniowy Upper/Lower dla osób początkujących.\n\nRób ćwiczenia do upadku, notuj ciężary, jeśli robisz więcej powtórzeń tym samym ciężarem co tydzień temu - Dołóż sobie.\n\nSam notuj serie, powtórzenia i ciężar. Baw się, eksperymentuj, progresuj i dowolnie modyfikuj pod samego siebie.",
            days: [
                { name: "Poniedziałek - Upper A", active: true, rows: [["Wyciskanie płaska","4","6-10",""],["Podciąganie szerokie","4","8-12",""],["Wiosłowanie","4","8-12",""],["OHP","4","8-12",""],["Wznosy","4","8-12",""],["Biceps","4","8-12",""],["Triceps","4","8-12",""]] },
                { name: "Wtorek - Lower A", active: true, rows: [["Przysiad","4","6-10",""],["RDL","4","8-12",""],["Hip thrust","4","8-12",""],["Prostowanie nóg na maszynie","4","8-12",""],["Brzuch maszyna","4","8-12",""],["Unoszenie kolan po skosie wiszac","4","8-12",""],["Łydki","4","15+",""]] },
                { name: "Środa", active: false, rows: [] },
                { name: "Czwartek - Upper B", active: true, rows: [["Wiosłowanie","4","8-12",""],["Podciąganie neutralny chwyt","4","8-12",""],["Wyciskanie płaskie","4","8-12",""],["Dipy","4","8-12",""],["OHP","4","8-12",""],["Wznosy","4","8-12",""],["Biceps","4","8-12",""]] },
                { name: "Piątek - Lower B", active: true, rows: [["Martwy ciąg","4","6-10",""],["Przysiady bułgarskie","4","8-12",""],["Uginanie nóg na maszynie","4","8-12",""],["Back extension","4","8-12",""],["Brzuszki skośne","4","8-12",""],["Unoszenie kolan w opadzie","4","8-12",""],["Łydki","4","15+",""]] },
                { name: "Sobota", active: false, rows: [] },
                { name: "Niedziela", active: false, rows: [] }
            ]
        },
        [DEFAULT_PLAN_5D]: {
            version: GLOBAL_PLAN_VERSION,
            notes: "Przykładowy trening 5 dniowy Upper/Lower Push Pull Legs dla osób mniej początkujących.\n\nRób ćwiczenia do upadku, notuj ciężary, jeśli robisz więcej powtórzeń tym samym ciężarem co tydzień temu - Dołóż sobie.\n\nSam notuj serie, powtórzenia i ciężar. Baw się, eksperymentuj, progresuj i dowolnie modyfikuj pod samego siebie.",
            days: [
                { name: "Poniedziałek - Upper", active: true, rows: [["Wyciskanie płaska","4","6-10",""],["Podciąganie szerokie","4","8-12",""],["Wiosłowanie szerokie","4","8-12",""],["OHP","4","8-12",""],["Wznosy na wyciągu","4","8-12",""],["Biceps","4","8-12",""],["Triceps","4","8-12",""]] },
                { name: "Wtorek - Lower", active: true, rows: [["Przysiad","4","6-10",""],["RDL","4","8-12",""],["Hip thrust","4","8-12",""],["Prostowanie nóg na maszynie","4","8-12",""],["Brzuch maszyna","4","8-12",""],["Unoszenie kolan po skosie wiszac","4","8-12",""],["Łydki","4","8-12",""]] },
                { name: "Środa", active: false, rows: [] },
                { name: "Czwartek - Push", active: true, rows: [["Wyciskanie na płaskiej","4","6-10",""],["Hantle skos","4","8-12",""],["Rozpiętki maszyna","4","8-12",""],["OHP","3","8-12",""],["Wznosy wyciąg","4","8-12",""],["Triceps warkocz","4","8-12",""],["Triceps nad głową","4","8-12",""]] },
                { name: "Piątek - Pull", active: true, rows: [["Wiosłowanie","4","8-12",""],["Podciąganie neutralnym chwytem","4","8-12",""],["Pullover","4","8-12",""],["Tył barków","4","8-12",""],["Biceps modlitewnik","4","8-12",""],["Biceps jednorącz","4","8-12",""],["Przedramie","3","8-12",""]] },
                { name: "Sobota - Legs", active: true, rows: [["Przysiad","4","6-10",""],["Martwy ciąg","4","6-10",""],["Prostowanie nóg","4","8-12",""],["Uginanie nóg","4","8-12",""],["Unoszenie kolan wisząc","4","8-12",""],["Brzuszki skośne","4","8-12",""],["Łydki","4","15+",""]] },
                { name: "Niedziela", active: false, rows: [] }
            ]
        }
    };
}

let plans = JSON.parse(localStorage.getItem("plans")) || {};
let checks = JSON.parse(localStorage.getItem("checks")) || {};
let currentPlan = localStorage.getItem("currentPlanName");

const defaultPlans = getDefaultPlans();

// Aktualizacja domyślnych planów (dodanie nowych lub nadpisanie starych wersji)
Object.keys(defaultPlans).forEach(planName => {
    if (!plans[planName] || plans[planName].version !== GLOBAL_PLAN_VERSION) {
        plans[planName] = defaultPlans[planName];
    }
});

if (!currentPlan || !plans[currentPlan]) {
    currentPlan = DEFAULT_PLAN_3D;
}

Object.keys(plans).forEach(key => { 
    if (Array.isArray(plans[key])) plans[key] = { notes: "", days: plans[key] }; 
});

let editStates = {};
let lastMovedRow = null;

function save() {
    localStorage.setItem("plans", JSON.stringify(plans));
    localStorage.setItem("checks", JSON.stringify(checks));
    localStorage.setItem("currentPlanName", currentPlan);
}

function autoHeight(el) { el.style.height = "auto"; el.style.height = (el.scrollHeight) + "px"; }
function saveNotes() { if (currentPlan) { plans[currentPlan].notes = document.getElementById("planNotes").value; save(); } }
function updDayName(di, val) { getDays()[di].name = val; save(); }
function getDays() { return (currentPlan && plans[currentPlan]) ? plans[currentPlan].days : []; }

function render() {
    const scrollPos = window.scrollY;
    const weekEl = document.getElementById("week");
    const notesEl = document.getElementById("planNotes");
    weekEl.innerHTML = "";
    if(!currentPlan || !plans[currentPlan]) return;

    notesEl.value = plans[currentPlan].notes || "";
    autoHeight(notesEl);

    const days = getDays();
    days.forEach((day, di) => {
        const isEditing = editStates[di];
        const dayChecks = checks[currentPlan]?.[di] || {};
        const activeToday = Object.values(dayChecks).some(v => v);

        const d = document.createElement("div");
        d.className = "day " + (day.active ? '' : 'inactive ') + (isEditing ? 'editing ' : '') + (activeToday && day.active ? 'active-today' : '');
        
        let rowsHtml = day.rows.map((r, ri) => {
            const isMoved = (lastMovedRow && lastMovedRow.di === di && lastMovedRow.ri === ri);
            return `
                <tr class="${dayChecks[ri] ? 'done' : ''} ${isMoved ? 'moved-row' : ''}">
                    <td class="col-check"><input type="checkbox" ${dayChecks[ri] ? 'checked' : ''} onchange="toggleCheck(${di},${ri},this.checked)"></td>
                    <td class="ex-name"><input type="text" value="${r[0]||''}" oninput="updRow(${di},${ri},0,this.value)" placeholder="..."></td>
                    <td class="col-s"><input type="text" inputmode="decimal" value="${r[1]||''}" oninput="updRow(${di},${ri},1,this.value)"></td>
                    <td class="col-p"><input type="text" inputmode="decimal" value="${r[2]||''}" oninput="updRow(${di},${ri},2,this.value)"></td>
                    <td class="col-kg"><input type="text" inputmode="decimal" value="${r[3]||''}" oninput="updRow(${di},${ri},3,this.value)"></td>
                    <td class="edit-ui">
                        <div class="row-ops">
                            <div class="move-up-down">
                                <button onclick="moveRow(${di},${ri},-1)">▲</button>
                                <button onclick="moveRow(${di},${ri},1)">▼</button>
                            </div>
                            <button onclick="delRow(${di},${ri})" style="color:var(--danger); border:none; background:none; font-size:18px;">✕</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        d.innerHTML = `
            <div class="day-header">
                <input class="day-title-input" value="${day.name}" ${isEditing ? '' : 'readonly'} oninput="updDayName(${di}, this.value)">
                <div style="display:flex; gap:6px; flex-shrink:0;">
                    <button class="icon-btn" style="height:32px; width:32px" onclick="toggleDay(${di})"><i data-lucide="${day.active ? 'pause' : 'play'}" style="width:14px"></i></button>
                    <button class="icon-btn ${isEditing ? 'gold' : ''}" style="height:32px; width:70px; font-size:10px; font-weight:bold" onclick="toggleEdit(${di})">${isEditing ? 'GOTOWE' : 'EDYTUJ'}</button>
                </div>
            </div>
            <table>
                <thead><tr><th class="col-check">✔</th><th class="ex-name">Ćwiczenie</th><th class="col-s">S</th><th class="col-p">P</th><th class="col-kg">kg</th><th class="edit-ui">Opcje</th></tr></thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            <button class="btn-add-row" onclick="addRow(${di})">+ DODAJ ĆWICZENIE</button>
        `;
        weekEl.appendChild(d);
    });
    lucide.createIcons();
    window.scrollTo(0, scrollPos);
    lastMovedRow = null;
}

function toggleEdit(di) { editStates[di] = !editStates[di]; render(); }
function addRow(di) { getDays()[di].rows.push(["", "", "", ""]); save(); render(); }
function delRow(di, ri) { if(confirm("Usunąć?")) { getDays()[di].rows.splice(ri, 1); save(); render(); } }
function moveRow(di, ri, dir) {
    const r = getDays()[di].rows;
    const t = ri + dir;
    if(t >= 0 && t < r.length) { 
        [r[ri], r[t]] = [r[t], r[ri]]; 
        lastMovedRow = { di: di, ri: t }; 
        save(); render(); 
    }
}
function updRow(di, ri, ci, v) { getDays()[di].rows[ri][ci] = v; save(); }
function toggleCheck(di, ri, v) {
    if(!checks[currentPlan]) checks[currentPlan] = {};
    if(!checks[currentPlan][di]) checks[currentPlan][di] = {};
    checks[currentPlan][di][ri] = v;
    save(); render();
}
function toggleDay(di) { getDays()[di].active = !getDays()[di].active; save(); render(); }
function resetWeek() { if(confirm("Zresetować postępy?")) { checks[currentPlan] = {}; save(); render(); } }
function loadPlan() { currentPlan = document.getElementById("planSelect").value; save(); render(); }
function newPlan() {
    const n = prompt("Nazwa planu:");
    if(n) { 
        const dni = ["Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota", "Niedziela"];
        plans[n] = { notes: "", days: dni.map(d => ({ name: d, active: true, rows: [] })) };
        currentPlan = n; save(); location.reload(); 
    }
}
function deletePlan() {
    if(confirm(`Usuń plan ${currentPlan}?`)) {
        delete plans[currentPlan];
        currentPlan = Object.keys(plans)[0] || null;
        save(); location.reload();
    }
}
function openExport() {
    const out = [];
    const p = plans[currentPlan];
    const days = getDays();
    const notes = p.notes || "";
    out.push(`!!NOTES!!\t${notes.replace(/\n/g, "[BR]")}`);
    days.forEach(d => {
        out.push(`# ${d.name} | ${d.active ? "AKTYWNY" : "PRZERWA"}`);
        d.rows.forEach(r => out.push(r.join("\t")));
    });
    document.getElementById("exportText").value = out.join("\n");
    document.getElementById("exportModal").classList.add("active");
}
function downloadTSV() {
    const t = document.getElementById("exportText").value;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([t], {type:"text/tab-separated-values"}));
    a.download = currentPlan.replace(/\s/g, '_') + ".tsv"; a.click();
}
function openImport() { document.getElementById("importModal").classList.add("active"); }
function handleFileSelect(e) {
    const r = new FileReader();
    r.onload = (e) => { document.getElementById("importText").value = e.target.result; };
    r.readAsText(e.target.files[0]);
}
function applyImport() {
    const lines = document.getElementById("importText").value.trim().split("\n");
    const week = []; let day = null; let notes = "";
    lines.forEach(l => {
        if (l.startsWith("!!NOTES!!")) { notes = l.split("\t")[1].replace(/\[BR\]/g, "\n"); }
        else if (l.startsWith("#")) {
            const [n, s] = l.replace("#", "").split("|").map(x => x.trim());
            day = { name: n, active: s === "AKTYWNY", rows: [] };
            week.push(day);
        } else if (day && l.trim()) { day.rows.push(l.split("\t")); }
    });
    if(week.length > 0) { plans[currentPlan] = { notes: notes, days: week }; save(); location.reload(); }
}
function closeModals() { document.querySelectorAll(".modal").forEach(m => m.classList.remove("active")); }

const ps = document.getElementById("planSelect");
Object.keys(plans).sort().forEach(p => {
    const o = document.createElement("option"); o.value = p; o.textContent = p;
    ps.appendChild(o);
});
ps.value = currentPlan;
render();
</script>
</body>
</html>

